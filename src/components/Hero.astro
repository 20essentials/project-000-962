---
import { baseUrl } from '@/utils/functions';
import MenuTooltip from '@/components/MenuTooltip.astro';
const languages = ['html', 'css', 'javascript', 'preview'];
---

<script>
  import { encode, decode } from 'js-base64';
  import { $, closeOrOpenModal } from '@/utils/functions';
  import Dracula from 'monaco-themes/themes/Dracula.json';
  import * as Monaco from 'monaco-editor';
  import HtmlWorker from 'monaco-editor/esm/vs/language/html/html.worker?worker';
  import CssWorker from 'monaco-editor/esm/vs/language/css/css.worker?worker';
  import JsWorker from 'monaco-editor/esm/vs/language/typescript/ts.worker?worker';
  import { debounce, updateUrlQueries } from '@/utils/functions';
  import { useEmmet } from '@/utils/emmet';
  import {
    INITIAL_CSS,
    INITIAL_HTML,
    INITIAL_JS,
    COMMON_OPTIONS_EDITOR
  } from '@/utils/consts';

  window.MonacoEnvironment = {
    getWorker(_, label) {
      if (label === 'html') return new HtmlWorker();
      if (label === 'javascript') return new JsWorker();
      if (label === 'css') return new CssWorker();
      return new JsWorker(); // fallback
    }
  };

  Monaco.editor.defineTheme(
    'Dracula',
    Dracula as Monaco.editor.IStandaloneThemeData
  );

  const $containerHTML = $('.editor-html') as HTMLElement;
  const $containerCSS = $('.editor-css') as HTMLElement;
  const $containerJS = $('.editor-javascript') as HTMLElement;
  const $iframe = $('.editor-preview') as HTMLIFrameElement;

  const currentUrl = new URL(window.location.href);
  const [htmlCodificado, cssCodificado, jsCodificado] = [
    'HTML',
    'CSS',
    'JavaScript'
  ].map(lang => currentUrl.searchParams.get(lang));

  let htmlValue = htmlCodificado ? decode(htmlCodificado) : '';
  let cssValue = cssCodificado ? decode(cssCodificado) : '';
  let jsValue = jsCodificado ? decode(jsCodificado) : '';
  // let htmlValue = INITIAL_HTML;
  // let cssValue = INITIAL_CSS;
  // let jsValue = INITIAL_JS;

  interface LanguageConfig {
    container: HTMLElement;
    value: string;
  }

  const allLanguages: [string, LanguageConfig][] = [
    ['html', { container: $containerHTML, value: htmlValue }],
    ['css', { container: $containerCSS, value: cssValue }],
    ['javascript', { container: $containerJS, value: jsValue }]
  ];

  const editors = allLanguages.map(([languageName, language]) => {
    const editor = Monaco.editor.create(language.container, {
      value: language.value,
      language: languageName,
      ...COMMON_OPTIONS_EDITOR,
      theme: 'Dracula'
    });

    editor.onDidChangeModelContent(debounce(updateIframe, 200));

    return editor;
  });

  const [htmlEditor, cssEditor, javascriptEditor] = editors;
  useEmmet(Monaco, htmlEditor);

  function updateIframe() {
    const htmlValue = htmlEditor.getValue().trim();
    const cssValue = cssEditor.getValue().trim();
    const jsValue = javascriptEditor.getValue().trim();
    updateUrlQueries({ htmlValue, cssValue, jsValue });

    $iframe.setAttribute(
      'srcDoc',
      `
      <!DOCTYPE html>
      <html lang="en">
      <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Preview</title>
        <style>
          *,
          *::after,
          *::before {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
          }

          body {
            background-color: #fff;
          }

          ${cssValue}</style>
      </head>
      <body>
        ${htmlValue}<script>${jsValue}<\/script>
      </body>
      </html>
    `
    );
  }

  document.addEventListener('DOMContentLoaded', () => {
    updateIframe();
  });

  window.addEventListener('keydown', e => {
    const { ctrlKey, metaKey, key } = e;
    if ((ctrlKey || metaKey) && key.toLowerCase() === 'p') {
      e.preventDefault();
      closeOrOpenModal();
    }

    if (key == 'Escape') {
      const $modalPreview = $('.modal-preview') as HTMLElement;
      if ($modalPreview?.classList.contains('open')) {
        const $menuTooltip = $('.menu-tooltip');
        $modalPreview.classList.remove('open');
        $menuTooltip?.classList.remove('menul-tooltip-open');
        return;
      }
    }
  });
</script>

<section class='main-section'>
  {
    languages.map(language => {
      const isPreview = language === 'preview';
      const TagElement = isPreview ? 'iframe' : 'article';
      const srcImage = baseUrl(`assets/${language}.svg`);
      return (
        <aside class='container-one-editor'>
          <TagElement class={`editor editor-${language}`} />
          {!isPreview && (
            <img class='am-logo' src={srcImage} alt={`Image ${language}`} />
          )}
        </aside>
      );
    })
  }

  <article class='modal-preview'></article>

  <MenuTooltip />
</section>

<style>
  .modal-preview {
    width: 100%;
    height: 100vh;
    position: absolute;
    z-index: 100;
    background-color: #0004;
    backdrop-filter: blur(0.1vmax);
    display: flex;
    transform: scale(0);
    content-visibility: auto;
    transition: transform 0.3s ease;
    transform-origin: 78% 73%;

    &.open {
      transform: scale(1);
    }

    iframe {
      width: 100%;
      height: 100%;
      resize: none;
      border: 0.1vmax solid #fff2;
      font-size: 1.2vmax;
      padding: 2vmax;
      display: flex;
      position: absolute;
      outline: none;
      background-color: #000;
      overflow: hidden;
      padding-left: 5vmax;
    }
  }

  .main-section {
    height: 100vh;
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    grid-template-rows: repeat(2, 1fr);

    .container-one-editor {
      position: relative;
      user-select: none;

      .editor {
        width: 100%;
        height: 100%;
        resize: none;
        border: 0.1vmax solid #fff2;
        font-size: 1.2vmax;
        padding: 1vmax;
        display: flex;
        position: absolute;
        outline: none;
        background-color: #000;
        overflow: hidden;

        .monaco-editor {
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
        }

        &.editor-preview {
          background-color: #000;
        }
      }

      .am-logo {
        position: absolute;
        width: 3vmax;
        height: 3vmax;
        right: 2.5vmax;
        bottom: 2vmax;
        z-index: 100;
        pointer-events: none;
      }
    }
  }
</style>

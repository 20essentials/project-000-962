---
import { baseUrl } from '@/utils/functions';
const languages = ['html', 'css', 'javascript', 'preview'];
---

<script>
  import { $ } from '@/utils/functions';
  import Dracula from 'monaco-themes/themes/Dracula.json';
  import * as Monaco from 'monaco-editor';
  import HtmlWorker from 'monaco-editor/esm/vs/language/html/html.worker?worker';
  import CssWorker from 'monaco-editor/esm/vs/language/css/css.worker?worker';
  import JsWorker from 'monaco-editor/esm/vs/language/typescript/ts.worker?worker';
  import {
    emmetHTML,
    emmetCSS,
    emmetJSX,
    expandAbbreviation
  } from 'emmet-monaco-es';
  import {
    INITIAL_CSS,
    INITIAL_HTML,
    INITIAL_JS,
    COMMON_OPTIONS_EDITOR
  } from '@/utils/consts';

  window.MonacoEnvironment = {
    getWorker(_, label) {
      if (label === 'html') return new HtmlWorker();
      if (label === 'javascript') return new JsWorker();
      if (label === 'css') return new CssWorker();
      return new JsWorker(); // fallback
    }
  };

  //@ts-ignore
  Monaco.editor.defineTheme('Dracula', Dracula);

  const $containerHTML = $('.editor-html') as HTMLElement;
  const $containerCSS = $('.editor-css') as HTMLElement;
  const $containerJS = $('.editor-javascript') as HTMLElement;
  const $iframe = $('.editor-preview') as HTMLIFrameElement;

  let htmlValue = INITIAL_HTML;
  let cssValue = INITIAL_CSS;
  let jsValue = INITIAL_JS;

  interface LanguageConfig {
    container: HTMLElement;
    value: string;
  }

  const allLanguages: [string, LanguageConfig][] = [
    ['html', { container: $containerHTML, value: htmlValue }],
    ['css', { container: $containerCSS, value: cssValue }],
    ['javascript', { container: $containerJS, value: jsValue }]
  ];

  const editors = allLanguages.map(([languageName, language]) => {
    const editor = Monaco.editor.create(language.container, {
      value: language.value,
      language: languageName,
      ...COMMON_OPTIONS_EDITOR,
      theme: 'Dracula'
    });

    editor.onDidChangeModelContent(updateIframe);

    return editor;
  });

  const [htmlEditor, cssEditor, javascriptEditor] = editors;

  //Autocomplete emmet solo con Tab
  htmlEditor.addCommand(Monaco.KeyCode.Tab, () => {
    const model = htmlEditor.getModel();
    const selection = htmlEditor.getSelection();
    if (!model || !selection) return;

    const position = selection.getStartPosition();
    const lineContent = model.getLineContent(position.lineNumber);
    const prefix = lineContent.slice(0, position.column - 1).trim();

    // Evita expandir si no hay texto o si tiene espacios (no es una abreviación válida)
    if (!prefix || /\s/.test(prefix)) return;

    const expanded = expandAbbreviation(prefix, { syntax: 'html' });
    if (!expanded) return;

    const range = new Monaco.Range(
      position.lineNumber,
      lineContent.lastIndexOf(prefix) + 1,
      position.lineNumber,
      position.column
    );

    htmlEditor.executeEdits('', [
      { range, text: expanded, forceMoveMarkers: true }
    ]);
  });

  function updateIframe() {
    const htmlValue = htmlEditor.getValue();
    const cssValue = cssEditor.getValue();
    const jsValue = javascriptEditor.getValue();

    $iframe.setAttribute(
      'srcDoc',
      `
      <!DOCTYPE html>
      <html lang="en">
      <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Preview</title>
        <style>${cssValue}</style>
      </head>
      <body>
        ${htmlValue}<script>${jsValue}<\/script>
      </body>
      </html>
    `
    );
  }

  emmetHTML(Monaco, ['html']);
  emmetCSS(Monaco, ['css', 'scss']);
  emmetJSX(Monaco, ['javascript', 'typescript']);

  document.addEventListener('DOMContentLoaded', () => {
    updateIframe();
  });
</script>

<section>
  {
    languages.map(language => {
      const isPreview = language === 'preview';
      const TagElement = isPreview ? 'iframe' : 'article';
      const srcImage = baseUrl(`assets/${language}.svg`);
      return (
        <aside class='container-one-editor'>
          <TagElement class={`editor editor-${language}`} />
          {!isPreview && (
            <img class='am-logo' src={srcImage} alt={`Image ${language}`} />
          )}
        </aside>
      );
    })
  }
</section>

<style>
  section {
    height: 100vh;
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    grid-template-rows: repeat(2, 1fr);

    .container-one-editor {
      position: relative;

      .editor {
        width: 100%;
        height: 100%;
        resize: none;
        border: 0.1vmax solid #fff2;
        font-size: 1.2vmax;
        padding: 1vmax;
        display: flex;
        position: absolute;
        outline: none;
        background-color: #000;
        overflow: hidden;

        .monaco-editor {
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
        }

        &.editor-preview {
          background-color: #000;
        }
      }

      .am-logo {
        position: absolute;
        width: 3vmax;
        height: 3vmax;
        right: 2.5vmax;
        bottom: 2vmax;
        z-index: 100;
      }
    }
  }
</style>
